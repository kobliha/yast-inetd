/
 * File:        testsuite/tests/Inetd.ycp
 * Package:     Configuration of inetd
 * Summary:     Testsuite for Reading and Writing (x)inetd configuration
 * Authors:     Martin Vidner <mvidner@suse.cz>
 *              Petr Hadraba <phadraba@suse.cz>
 *
 * $Id$
 *
 * This is testsuite for Inetd.ycp source file.
 * These tests are checking reading and writing
 * of inetd or xinetd services.
 */

{

include "testsuite.ycp";
import "Inetd.ycp";
import "Report";

Report::DisplayErrors(false, 0);

map s = $[
    "iid": "whatever",
    "comment": "My service",
    "enabled": true,
    "service": "finger",
    "socket_type": "stream",
    "protocol": "tcp",
    "wait": false,
    "user": "nobody",
    "server": "/usr/sbin/tcpd",
    "server_args": "in.fingerd -w",
    ];

map service_on = $[
    "start": [ "3", "5"],
    "stop":  [ "3", "5"],
];

map service_off = $[
    "start": [],
    "stop":  [],
];

map READ = $[
    "target" : $[
	"size" : -1,
    ],
    "init" : $[
	"scripts" : $[
	    "exists" : true,
            "runlevel": $[
                "inetd":  service_on,
                "xinetd": service_on,
            ],
            "comment": $[
                "inetd":  $[],
                "xinetd": $[],
            ],
	]
    ],
    "targetpkg": $[
        "installed": true,
    ],
    "etc" : $[
	"inetd_conf" : $[
	    "services" : [ s ],
	    ],
        "xinetd_conf": $[
            "services":  [ s ],
            ],
	],
];

map READ2 = $[];
READ2 = eval(READ);
READ2["init", "scripts", "runlevel", "inetd"]  = service_off;

map READ3 = $[];
READ3 = eval(READ);
READ3["init", "scripts", "runlevel", "xinetd"] = service_off;

map WRITE = $[
];

map EXECUTE = $[
    "target": $[
        "bash_output": $[
            "exit":   0,
            "stdout": "",
            "stderr": "",
        ],
        "mkdir": true,
    ],
];

/*
 * All services are installed (inetd and xinetd)
 * All services are running
 * User will save and use inetd
 */
DUMP("\nAll services are running and inetd will be used\n");
DUMP("\nRead  --- read all services\n");

// filled by PackageDialog()
Inetd::netd_service = `both;

TEST(``(Inetd::Read()),  [READ, WRITE, EXECUTE], nil);

// filled by InetdDialog()
Inetd::inetd_status     = 0;
Inetd::xinetd_status    = 0;
Inetd::inetd_installed  = 0;
Inetd::xinetd_installed = 0;

// force inetd (by default filled by InetdDialog() according to user choice)
Inetd::netd_conf          = Inetd::inetd_conf;
Inetd::configured_service = `inetd;
Inetd::netd_status        = Inetd::inetd_status;

DUMP("\nWrite --- write inetd");
DUMP("  inetd and xinetd are installed and running\n");
TEST(``(Inetd::Write()), [READ, WRITE, EXECUTE], nil);

DUMP("\n  ---\n");

/*
 * All services are installed (inetd, xinetd)
 * All services are running
 * User will save and use xinetd
 */
DUMP("\nAll services are running and xinetd will be used\n");
DUMP("\nRead  --- read all services\n");

// filled by PackageDialog()
Inetd::netd_service = `both;

TEST(``(Inetd::Read()),  [READ, WRITE, EXECUTE], nil);

// filled by InetdDialog()
Inetd::inetd_status     = 0;
Inetd::xinetd_status    = 0;
Inetd::inetd_installed  = 0;
Inetd::xinetd_installed = 0;

// force inetd (by default filled by InetdDialog() according to user choice)
Inetd::netd_conf          = Inetd::xinetd_conf;
Inetd::configured_service = `xinetd;
Inetd::netd_status        = Inetd::xinetd_status;

DUMP("\nWrite --- write xinetd");
DUMP("  inetd and xinetd are installed and running\n");
TEST(``(Inetd::Write()), [READ, WRITE, EXECUTE], nil);

DUMP("\n  ---\n");

/*
 * All services are installed (inetd, xinetd)
 * xinetd is running
 * User will save and use inetd
 */
DUMP("\nxinetd is running and inetd will be used\n");
DUMP("\nRead  --- read all services\n");

// filled by PackageDialog()
Inetd::netd_service = `both;

TEST(``(Inetd::Read()),  [READ2, WRITE, EXECUTE], nil);

// filled by InetdDialog()
Inetd::inetd_status     = 3; // unused
Inetd::xinetd_status    = 0;
Inetd::inetd_installed  = 0;
Inetd::xinetd_installed = 0;

// force inetd (by default filled by InetdDialog() according to user choice)
Inetd::netd_conf          = Inetd::inetd_conf;
Inetd::configured_service = `inetd;
Inetd::netd_status        = 0; // start this (inetd) service

DUMP("\nWrite --- write inetd");
DUMP("  inetd and xinetd are installed and only xinetd is running\n");
TEST(``(Inetd::Write()), [READ2, WRITE, EXECUTE], nil);

DUMP("\n  ---\n");

/*
 * All services are installed (inetd, xinetd)
 * inetd is running
 * User will save and use xinetd
 */
DUMP("\ninetd is running and xinetd will be used\n");
DUMP("\nRead  --- read all services\n");

// filled by PackageDialog()
Inetd::netd_service = `both;

TEST(``(Inetd::Read()),  [READ3, WRITE, EXECUTE], nil);

// filled by InetdDialog()
Inetd::inetd_status     = 0;
Inetd::xinetd_status    = 3; // unused
Inetd::inetd_installed  = 0;
Inetd::xinetd_installed = 0;

// force inetd (by default filled by InetdDialog() according to user choice)
Inetd::netd_conf          = Inetd::xinetd_conf;
Inetd::configured_service = `xinetd;
Inetd::netd_status        = 0; // start this (xinetd) service

DUMP("\nWrite --- write xinetd");
DUMP("  inetd and xinetd are installed and only inetd is running\n");
TEST(``(Inetd::Write()), [READ3, WRITE, EXECUTE], nil);

DUMP("\n  ---\n");

}
